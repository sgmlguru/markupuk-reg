# MUK-reg

This is a registration app for Markup UK, 2019 edition, intended to run in eXist-DB. It registers a delegate, allows her to pay using Paypal, and then sends an invoice to the given email, plus a copy to the business email defined in `resources/xml/config.xml`.

Any user data (XML and PDF) is saved in `/db/MUK-data` or whatever collections that have been defined in the config XML file.

Note that while most configuration of the app can be done though the admin XForm, some of the config information still needs to be entered directly in the XML.


## Basic Registration Workflow

1. The user fills in the XForm `http://<domain>/exist/rest/db/apps/MUK-reg/registration-form.xhtml` and hits *Register*.
2. The XQuery captures the XForm output and saves the resulting XML in a file named after the person, sans any spaces, appending date/time and `-tmp` to the filename. The temp file is saved in `<env>/tmp`.
3. The app returns a summary and a Paypal button.
4. The user pays through Paypal.
5. Upon return, the app confirms the payment and moves the temp XML to `<env>/data`, removing the `-tmp` string in the filename and adding transaction information.
3. The app transforms the XML to XSL-FO format and feeds that to FOP for PDF rendering.
4. The app saves the PDF to `<env>/pdf` with the same name as the XML, except for the file suffix.
5. The app sends the PDF to the email found in the registration XML, plus to the business email defined in `resources/xml/config.xml`.  


## Install

1. Install eXist-DB 4.6.1 or later. **NOTE! The app should be installed in the default location for now!**
2. Install XSLT Forms. *This step should be optional, as the app should be able to detect the missing dependency.*
3. From `bin/`, upload and install the latest XAR package using eXist's Package Manager.
4. Open http://localhost:8080/exist/rest/db/apps/MUK-reg/admin.xhtml (replace `localhost:8080` with your domain and port number) in a browser.
5. Enter the domain, for example, 'https://example.com'. If you use a port number, that needs to be included here. **NOTE! PayPal will not accept port numbers or http in a live setting!**
6. Select the MUK data root collection (the default '/db' should be fine) and hit **Update**. This adds the required collections to the MUK app data and then sets the appropriate permissions.
7. Select the 'Sandbox' environment in the **Environment** drop-down list and hit **Update Environment**.
8. Open `resources/xml/config.xml` in an XML editor and update the PayPal client ID information.
9. Update the business information in the config XML.
8. Test, test, and then test some more. *Remember to test both Paypal login payments and credit card-only payments!*
9. When happy with your tests, change the environment to 'live' and make sure you test at least one live transaction.


## Technical Stuff

Most functionality is in `modules/muk-functions.xqm` (with some in `xq/register.xquery`). The XQM also contains global variables for the app config (pointing to `registration/xml/config.xml`; this should be updated by the admin UI only). There is also a Paypal listener in `modules/muk-paypal.xqm`.

There is XSLT for the invoice (XSL-FO stylesheet in `xsl/invoice.xsl`) and the summary page presented upon registration, before payment is complete (`xsl/summary.xsl`).

There is a CSS file in `resources/css/styles.css`, but currently, the XForms all use inline CSS. Images are in `resources/img`.


## Registration

When hitting **Register** in `http://<domain>/exist/apps/MUK-reg/registration-form.xhtml`, the XForm registration page saves its information in an XML file, stored in `${env}/tmp` where `${env}` is either 'sandbox' or 'live'. The file is named `${person}-${dateTimeStamp}-tmp.xml` where `${person}` is the name of the person who registered and `${dateTimeStamp}` the timestamp of the registration.

The app returns a summary page containing the info just saved (generated by `xsl/summary.xsl`) and a Paypal button with the correct amount and user ID injected through XQuery variables. This is all handled by `xq/register.xquery`. When the user hits the Paypal button, Paypal opens a popup for payment.

Upon completing payment, the PayPal script registers an *onApprove* event where a listener endpoint returns the user to a thank you page generated by `xq/thanks.xquery`. This XQ generates a PDF invoice and sends it to the email given by the delegate, with a copy to the business email given in the config XML, `resources/xmnl/config.xml`.

The listener saves a Paypal transaction file in `${env}/transactions`. this XML file contains a timestamp, the user ID generated by the app, and a Paypal order ID.

`thanks.xquery` also inserts the transaction data to the user XML, sets the `@paid` attribute to 'yes', adds an invoice number to the XML, moves the user XML with the delegate info to `${env}/data`, and saves a copy of the PDF invoice in `${env}/pdf`.


## Prerequisites

You need to have XSLTForms installed in eXist-DB.

**NOTE: The app is aware of the dependency but I've not tested installing the app on an installation of eXist that lacks XSLTForms.**


## Delegate XML Format

The delegate XML format that is saved in `data` looks like this:

``` 
<data>
    <person uid="68" orderID="" tstamp="" paid="yes">
        <name>John Doe</name>
        <address>
            <line1>1 Main St</line1>
            <line2/>
            <postcode>12345</postcode>
            <city>Big City</city>
            <country>big country</country>
            <eu>true</eu>
        </address>
        <affiliation>XML Examples Ltd</affiliation>
        <reverse-charge>false</reverse-charge>
        <vat-number/>
        <dietary>No nuts</dietary><!--<other/>-->
        <email>john@example.com</email>
        <preconf>true</preconf>
        <mailing-list>true</mailing-list>
        <type>full</type>
        <discount/>
        <date>2019-05-29T09:03:02.912-04:00</date>
        <invoice>MUK2019-REG-123</invoice>
    </person>
</data>
```

`reverse-charge=true` indicates that the delegate should not pay VAT. An EU company outside the UK should not pay UK VAT, while UK companies should, as should (of course) UK private citizens and EU ditto.

Non-EU delegates do NOT pay UK VAT.

The invoice number is generated by the `thanks.xquery` XQuery, based on the number of delegates in `data`. The UID, similarly, is the number of delegates saved in `tmp`.

**Multiple `person` elements (multiple people) are allowed but cannot currently be registered using the XForm. Instead, a manual process is needed. See below.**


## The Config XML Format

The configuration XML format updated by the `admin.xhtml` XForm looks like this:

```
<?xml version="1.0" encoding="UTF-8"?>
<config>
    <!-- This is a MUK Registration app config file -->
    
    <!-- MUK info -->
    <business>
        <name>Markup UK Conferences Limited</name>
        <email>info@markupuk.org</email>
        <pid>...</pid>
        <bank>HSBC</bank>
        <account>1234567890</account>
        <client-id>
            <sandbox>...</sandbox>
            <live>...</live>
        </client-id>
    </business>
    
    <!-- eXist-DB Domain -->
    <domain>http://localhost:8080</domain>
    
    <!-- Data root for MUK-data and subcollections -->
    <data-root>/db</data-root>
    
    <!-- Various collections in eXist; this needs work -->
    <collections>
        <root>MUK-data</root>
        <sandbox>sandbox</sandbox>
        <live>live</live>
        <sub>
            <tmp>tmp</tmp>
            <transactions>transactions</transactions>
            <data>data</data>
            <pdf>pdf</pdf>
        </sub>
    </collections>
    
    <!-- Current env -->
    <current>sandbox</current>
    
    <!-- The currently *selected* path (live or sandbox, basically) -->
    <data-uri>/db/MUK-data/sandbox</data-uri>
    
    <stylesheets>
        <fo>/db/apps/MUK-reg/xsl/invoice.xsl</fo>
        <summary>/db/apps/MUK-reg/xsl/summary.xsl</summary>
    </stylesheets>
    
    <prefixes>
        <invoice>MUK2019-REG-</invoice>
        <uid/>
    </prefixes>
    
    <!-- Pricing -->
    <pricing>
        
        <types>
            <type use="yes" inc="204" exc="170">
                <name>Student (£204 incl VAT)</name>
                <value>academic</value>
            </type>
            <type use="yes" inc="258" exc="215">
                <name>Early Bird (£258 incl VAT)</name>
                <value>early-bird</value>
            </type>
            <type use="yes" inc="336" exc="280">
                <name>Full (£336 incl VAT)</name>
                <value>full</value>
            </type>
            <type use="yes" inc="204" exc="170">
                <name>Programme Committee Member (£204 incl VAT)</name>
                <value>pc</value>
            </type>
            <type use="yes" inc="0" exc="0">
                <name>Speaker (£0 incl VAT)</name>
                <value>speaker</value>
            </type>
        </types>
        
        <discounts>
            <discount use="yes" inc="243" exc="203">
                <label>CODE1</label>
            </discount>
            <discount use="yes" inc="1.5" exc="1.25">
                <label>CODE2</label>
            </discount>
            
        </discounts>
        
    </pricing>
    
</config>
```

The registration prices are entered in the XForm and saved in `type/@inc` and `discount/@inc`, respectively, and should be VAT inclusive. The XForm calculates the VAT exclusive values in `@exc`.


## Registration Confirmation

Currently, the email text is hard-coded in a function in `modules/MUK-functions.xqm`. This, of course, needs to change so the function can simply use a given email in, say, a config file handling the specifics of a particular use of the app.

Similarly, there is still hard-coded stuff in `xq/thanks.xquery` that needs to be moved.


## Bypassing Paypal Invoicing for Multiple Delegate Registrations

Sometimes, you need to invoice an organisation for multiple delegates in a single invoice. This is entirely doable by writing the temp XML file manually. For example, here is a temp XML for two delegates from OUP:

```
<data>
    <person uid="19" paid="no">
        <name>Mark D</name>
        <address>
            <line1>Great Street</line1>
            <line2/>
            <postcode>OLX 1ED</postcode>
            <city>Reading</city>
            <country>United Kingdom</country>
        </address>
        <affiliation>Reading Ltd</affiliation>
        <dietary/>
        <email>mark.d@example.com</email>
        <preconf>false</preconf>
        <mailing-list>false</mailing-list>
        <type>early-bird</type>
        <discount/>
        <date>2019-04-08T18:59:41.222+02:00</date>
    </person>
    <person>
        <name>Julia D</name>
        <address>
            <line1>Great Street</line1>
            <line2/>
            <postcode>OLX 1ED</postcode>
            <city>Reading</city>
            <country>United Kingdom</country>
        </address>
        <affiliation>Reading Ltd</affiliation>
        <dietary/>
        <email>julia.d@example.com</email>
        <preconf>false</preconf>
        <mailing-list>false</mailing-list>
        <type>early-bird</type>
        <discount/>
        <date>2019-04-08T18:59:41.222+02:00</date>
    </person>
</data>
```

This was written manually in oXygen, based on an earlier registration but changing the delegate data, and then *uploaded* to `live/tmp`, since the registration XForm can only handle a single delegate at a time.

The `@uid`, `@paid`, and `date` markup is manually entered; the UID is a simple count (+1) of files in `tmp`, while the timestamp is real but manually generated in oXygen.

Based on the UID ("19"), I then created `transactions/uid-19.xml`:

```
<transaction tstamp="2019-04-08T18:59:41.222+02:00" orderID="TEMP" userID="19"/>
```

This is also fake, of course.

Finally, I entered the following in the browser URL field:

```
https://<domain>/exist/rest/db/apps/MUK-reg/xq/thanks.xquery?tmp-file=/db/MUK-data/live/tmp/MarkD-20190408T1859412220200-tmp.xml
```

This runs `thanks.xquery` on the temp file, given with `tmp-file=/db/MUK-data/live/tmp/MarkD-20190408T1859412220200-tmp.xml`. Note that the temp file follows the naming conventions for the autogenerated XML, allowing the PDF and the registered data to use the same conventions.

`thanks.xquery` sets `@paid='yes'` (not true, strictly speaking), removes `-tmp` in the filename, adds an invoice number to the XML, generates a PDF invoice, and sends the invoice to the *first email address in the XML* (since we allow for multiple persons, we only use the first person's email).


### Prerequisites

We assume the following when running a multiple-person invoice as described above:
* All delegates in the same XML use the same registration type (early-bird, full, etc)
* All delegates in the same XML use the same discount code, if any
* The invoice is addressed to the first person in the XML
* Only the first person's address is used

If any of the above isn't true, you need to generate separate invoices.


## Questions & Comments

If something doesn't work or you discover a bug, ping me.


[Ari Nordström](ari@markupuk.org), 20190731